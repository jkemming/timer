<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <link rel="icon" href="/favicon.ico" type="image/x-icon">

  <title>00:00 #[[${room.name}]]</title>

  <style>
    @media (min-width: 992px) {
      .container{
        max-width: 720px;
      }
    }
  </style>
</head>
<body>

<div class="progress" style="height: 3px;">
  <div class="progress-bar" role="progressbar" id="progressbar" style="width: 0%;"></div>
</div>

<main class="container">

<div class="col-lg-8 mx-auto p-3 py-md-5">

  <div class="text-center mb-5">
    <a href="/myroom" th:href="|/${room.name}|" class="text-body text-decoration-none">#[[${room.name}]]</a>

   <div class="display-1">
     <span id="timer-type"></span>
     <span id="timer" class="font-monospace">00:00</span>
   </div>

    <div>
     <span id="timer-user" class="text-muted"></span>
     <span id="timer-next-user" class="text-muted" title="next person"></span>
    </div>

  </div>
</div>

  <div id="history-container" class="mb-5" style="display: none">
    <h5>History <small class="text-muted">Last 24h</small></h5>
    <ul id="history" class="list-unstyled font-monospace">
    </ul>
  </div>

  <div id="usage-container">
    <h5>Usage</h5>
    <ul class="list-unstyled">
      <li><code>export MOB_TIMER_ROOM=[[${room.name}]]</code></li>
    </ul>
    <ul class="list-unstyled">
      <li><code>mob start 10</code></li>
      <li><code>mob timer 10</code></li>
      <li><code>mob break 5</code></li>
    </ul>
  </div>

</main>

<footer class="text-center text-muted small mt-5">
  <p>
    <a href="#" onclick="enableAudio()" id="audio-interaction">Activate Audio</a>
    <span id="audio-speaker" onclick="toggleAudio()"></span>
    |
    <a href="/help">Help</a>
    |
    <a href="https://github.com/remotemobprogramming/timer">View on Github</a>
    |
    <a href="https://mob.sh">mob.sh</a>
  </p>

  <p>
    Crafted by <a href="https://twitter.com/simonharrer">Dr. Simon Harrer</a> &amp; <a href="https://twitter.com/jochen_christ">Jochen Christ</a>
  </p>
</footer>

 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
  <script type="text/javascript">
    if ("Notification" in window) {
      Notification.requestPermission();
    }
  </script>
  <script type="text/javascript">

    function hasCurrentUser() {
      let currentUser = getCurrentUser();
      return currentUser instanceof String && currentUser !== "";
    }

    function getCurrentUser() {
      return localStorage.getItem('user');
    }

    function setCurrentUser(user) {
      console.log("Setting user="+user);
      return localStorage.setItem('user', user);
    }

    function hasAudioEnabled() {
      return localStorage.getItem('audio') === 'true';
    }

    function enableAudio() {
      localStorage.setItem('audio', 'true');
      document.getElementById('audio-speaker').innerText = '🔉'
      checkAudioPlayback()
    }

    function disableAudio() {
      localStorage.setItem('audio', 'false');
      document.getElementById('audio-speaker').innerText = '🔇'
      checkAudioPlayback()
    }

    function toggleAudio() {
      hasAudioEnabled() ? disableAudio() : enableAudio();
    }

    hasAudioEnabled() ? enableAudio() : disableAudio();

    function addLeadingZero(num) {
      return (num < 10 ? '0' : '') + num;
    }

    function getCountdownRemainingTimeString(timerDurationInMilliseconds, elapsedMillisecondsSinceRequested) {
      let remainingDurationInMilliseconds = timerDurationInMilliseconds - elapsedMillisecondsSinceRequested;
      let remainingSeconds = Math.floor(remainingDurationInMilliseconds / 1000);
      let remainingMinutesPart = Math.floor(remainingSeconds / 60);
      let remainingSecondsPart = remainingSeconds % 60;
      return `${addLeadingZero(remainingMinutesPart)}:${addLeadingZero(remainingSecondsPart)}`;
    }

    function getCountdownPercentage(timerDurationInMilliseconds, elapsedMillisecondsSinceRequested) {
      let percentage = elapsedMillisecondsSinceRequested / timerDurationInMilliseconds * 100;
      return Math.max(0, Math.min(100, Math.floor(percentage * 100) / 100));
    }

    function formatTodayAware(timestamp) {
      let date = new Date(timestamp);
      return date.toLocaleDateString() === new Date().toLocaleDateString()
          ? date.toLocaleTimeString()
          : date.toLocaleString();
    }

    var timerDiv = document.getElementById('timer');
    function updateRemainingTime(data) {
      document.title = `${data} #${room}`;
      timerDiv.innerText = data;
    }

    var timerUserDiv = document.getElementById('timer-user');
    function updateTimerUser(data) {
      timerUserDiv.innerText = data !== null ? ` 👤 ${data}` : '';
    }

    var timerNextUserDiv = document.getElementById('timer-next-user');
    function updateTimerNextUser(data) {
      timerNextUserDiv.innerText = data !== null ? ` ➡️ ${data}` : '';
    }


    var timerTypeDiv = document.getElementById('timer-type');
    function updateTimerType(data) {
      timerTypeDiv.innerText = data === 'BREAKTIMER' ? '☕' : '';
    }

    function checkAudioPlayback() {
      if (!hasAudioEnabled()) {
        document.getElementById('audio-interaction').innerText = 'Audio activated';
        return;
      }

      new Audio('/silence.mp3').play().then((e) => {
        console.log("audio working");
        document.getElementById('audio-interaction').innerText = 'Audio activated';
      }, (e) => {
        console.log("audio not working")
        document.getElementById('audio-interaction').innerText = 'Activate Audio';
      })
    }

    function isTimerOfCurrentUser() {
      return hasCurrentUser() && requestUser === getCurrentUser();
    }

    function timerFinished() {
      console.log("Timer finished. Notifying user.");

      updateTimerUser(null);
      updateTimerNextUser(requestNextUser);
      updateTimerType(null);

      if ("Notification" in window) {
        Notification.requestPermission();
        new Notification(requestUser + ' $ ' + (requestType === "TIMER" ? 'mob next' : 'mob start'), {
          tag: 'timer-finished',
          body: requestTimer + " min timer is up.",
          icon: '/favicon.ico',
          lang: 'en',
        });
      }

      if (hasAudioEnabled()) {
        // isTimerOfCurrentUser() ? '/' + (requestType === "TIMER" ? 'mobnext.mp3' : 'mobstart.mp3') :
        let audioFile = '/timer.mp3';
        console.log("Playing " + audioFile);
        new Audio(audioFile).play().then(
            (e) => {},
            (e) => console.log("could not play " + e)
        )
      }
    }

    let room = '[[${room.name}]]';

    let roomEventsUrl = `/${room}/events`;
    console.log('setting up event source at ' + roomEventsUrl);
    const eventSource = new EventSource(roomEventsUrl);
    eventSource.onopen = () => {
      console.log('opened connection to ' + roomEventsUrl);
    };
    eventSource.onerror = (e) => {
      console.log('error on connection to ' + roomEventsUrl + ": " + e.data);
    };

    let progressbarElement = document.getElementById("progressbar");

    var requestedTimestamp = null;
    var timerDurationInMilliseconds = null;
    var isTimerRunning = false;
    var requestType = null;
    var requestUser = null;
    var requestNextUser = null;
    var requestTimer = null;


    function renderTimer() {
      if (requestedTimestamp !== null) {
        let elapsedMillisecondsSinceRequested = Date.now() - requestedTimestamp;
        if (elapsedMillisecondsSinceRequested < timerDurationInMilliseconds) {
          updateRemainingTime(
              getCountdownRemainingTimeString(timerDurationInMilliseconds,
                  elapsedMillisecondsSinceRequested)
          );
          progressbarElement.style = `width: ${getCountdownPercentage(timerDurationInMilliseconds,
              elapsedMillisecondsSinceRequested)}%`;
          isTimerRunning = true;
        } else {
          updateRemainingTime('00:00');
          progressbarElement.style = "width: 0%";

          if (isTimerRunning) {
            timerFinished();
          }

          isTimerRunning = false;
        }
      }
    }

    // loop
    function timer() {
      setTimeout(function () {
        renderTimer();
        timer();
      }, 50);
    }
    timer();

    function prependToHistory(newEntry) {
      let historyElement = document.getElementById('history');
      let current = historyElement.innerHTML.toString();
      if (!current.includes(newEntry)) {
        let newListItem = document.createElement("li");
        newListItem.innerText = newEntry;
        historyElement.prepend(newListItem);
      }
      document.getElementById('history-container').style.display = 'block';
    }

    function clearHistory() {
      document.getElementById('history').innerHTML = '';
      document.getElementById('history-container').style.display = 'none';
    }

    eventSource.addEventListener('TIMER_REQUEST', (e) => {
      console.log('handling event TIMER_REQUEST ' + e.data);
      let request = JSON.parse(e.data);

      if (request.timer === 0 && request.user === null) {
        console.log('Resetting state');

        requestedTimestamp = null
        timerDurationInMilliseconds = null
        requestType = null
        requestUser = null
        requestNextUser = null
        requestTimer = null

        updateTimerUser(null);
        updateTimerNextUser(null);

        clearHistory();

        return;
      }

      let finished = Date.parse(request.requested) + (request.timer * 60 * 1000);
      updateTimerUser(request.user)
      updateTimerNextUser(null)
      updateTimerType(request.type)

      requestedTimestamp = Date.parse(request.requested);
      timerDurationInMilliseconds = request.timer * 60 * 1000;
      requestType = request.type
      requestUser = request.user
      requestNextUser = request.nextUser
      requestTimer = request.timer

      prependToHistory(`🕒 ${formatTodayAware(request.requested)} ${request.type === "BREAKTIMER" ? "☕" : "⏲"} ${request.timer} min 🏁 ${(formatTodayAware(finished))} 👤 ${request.user}`);
    });

    checkAudioPlayback();
  </script>

<script async defer src="https://scripts.simpleanalyticscdn.com/latest.js"></script>
<noscript><img src="https://queue.simpleanalyticscdn.com/noscript.gif" alt="" referrerpolicy="no-referrer-when-downgrade" /></noscript>
</body>
</html>