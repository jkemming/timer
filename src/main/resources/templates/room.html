<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <title>00:00</title>
</head>
<body>

<div class="progress" style="height: 3px;">
  <div class="progress-bar" role="progressbar" id="progressbar" style="width: 0%;"></div>
</div>


<div class="col-lg-8 mx-auto p-3 py-md-5">

  <div class="text-center mb-5">
    #[[${room.name}]]

   <div class="display-1">
     <span id="timer-type"></span>
     <span id="timer" class="font-monospace">00:00</span>
   </div>

    <div>
     <span id="timer-duration" class="text-muted"></span>
     <span id="timer-user" class="text-muted"></span>
     <span id="timer-requested" class="text-muted"></span>
     <span id="timer-finished" class="text-muted"></span>
    </div>

  </div></div>



  <div class="row justify-content-center">
    <div class="col-6 mb-3" id="help">
        <h5>Help</h5>
          <pre>
# first, configure your local system ...
export MOB_TIMER_ROOM=[[${room.name}]]

# ... and then happy collaborating!
mob start 10

# You can always start a timer via
mob timer 10

# or have a 5 minute coffee break with
mob break 5
    </pre>
    </div>
  </div>

  <div class="row justify-content-center">
    <div class="col-6" id="history-col" style="display: none">
        <h5>History</h5>
        <ul id="history" class="list-unstyled">
        </ul>
    </div>
  </div>

 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
  <script type="text/javascript">
    Notification.requestPermission();
  </script>
  <script type="text/javascript">

    function addLeadingZero(num) {
      return (num < 10 ? '0' : '') + num;
    }

    function getCountdownRemainingTimeString(timerDurationInMilliseconds, elapsedMillisecondsSinceRequested) {
      var remainingDurationInMilliseconds = timerDurationInMilliseconds - elapsedMillisecondsSinceRequested;
      let remainingSeconds = Math.floor(remainingDurationInMilliseconds / 1000);
      let remainingMinutesPart = Math.floor(remainingSeconds / 60);
      let remainingSecondsPart = remainingSeconds % 60;
      return `${addLeadingZero(remainingMinutesPart)}:${addLeadingZero(remainingSecondsPart)}`;
    }

    function getCountdownPercentage(timerDurationInMilliseconds, elapsedMillisecondsSinceRequested) {
      let percentage = elapsedMillisecondsSinceRequested / timerDurationInMilliseconds * 100;
      return Math.max(0, Math.min(100, Math.floor(percentage)));
    }

    function formatTodayAware(timestamp) {
      let date = new Date(timestamp);
      return date.toLocaleDateString() === new Date().toLocaleDateString()
          ? date.toLocaleTimeString()
          : date.toLocaleString();
    }

    var timerDiv = document.getElementById('timer');
    function updateRemainingTime(data) {
      document.title = data;
      timerDiv.innerHTML = data;
    }

    var timerUserDiv = document.getElementById('timer-user');
    function updateTimerUser(data) {
      if (data !== undefined) {
        timerUserDiv.innerHTML = ` üë§ ${data}`;
      } else {
        timerUserDiv.innerHTML = "";
      }
    }

    var timerDurationDiv = document.getElementById('timer-duration');
    function updateTimerDuration(data) {
      timerDurationDiv.innerHTML = `‚è≤ ${data} min`;
    }

    var timerTypeDiv = document.getElementById('timer-type');
    function updateTimerType(data) {
      timerTypeDiv.innerHTML = data;
    }

    var timerRequestedDiv = document.getElementById('timer-requested');
    function updateTimerRequested(data) {
      if(data !== undefined) {
        timerRequestedDiv.innerHTML = ` üïí ${(formatTodayAware(data))}`;
      } else {
      timerRequestedDiv.innerHTML = data;
      }
    }

    var timerFinishedDiv = document.getElementById('timer-finished');
    function updateTimerFinished(data) {
      if(data !== undefined) {
        timerFinishedDiv.innerHTML = ` üèÅ ${(formatTodayAware(data))}`;
      } else {
        timerFinishedDiv.innerHTML = data;
      }
    }

    function timerFinished() {
      Notification.requestPermission();
      new Notification('mob next', {
        tag: 'timer-finished',
        silent: false,
        body: "Time's up.",
        lang: 'en',
      });
      new Howl({
        src: ['/mobnext.mp3']
      }).play();
    }

    let url = '/[[${room.name}]]/sse';
    console.log('setting up event source at ' + url);
    const eventSource = new EventSource(url);
    eventSource.addEventListener('TIMER_FINISHED', (e) => {
      console.log('TIMER_FINISHED');
      timerFinished();
    });

    let url2 = '/[[${room.name}]]/sse2';
    console.log('setting up event source at ' + url2);
    const eventSource2 = new EventSource(url2);
    eventSource2.onopen = () => {
      console.log('open');
    };
    eventSource2.onerror = (e) => {
      console.log('onerror');
      console.log(e);
      console.log(e.data);
    };

    let progressbarElement = document.getElementById("progressbar");

    var requestedTimestamp;
    var timerDurationInMilliseconds;

    function timer() {
      setTimeout(function () {
        if (requestedTimestamp !== undefined) {
          var elapsedMillisecondsSinceRequested = Date.now() - requestedTimestamp;
          if (elapsedMillisecondsSinceRequested < timerDurationInMilliseconds) {
            updateRemainingTime(
                getCountdownRemainingTimeString(timerDurationInMilliseconds,
                elapsedMillisecondsSinceRequested)
            );
            progressbarElement.style = `width: ${getCountdownPercentage(timerDurationInMilliseconds, elapsedMillisecondsSinceRequested)}%`;
          } else {
            updateRemainingTime('00:00');
            progressbarElement.style = "width: 0%";
          }
        }

        timer();
      }, 50);
    }
    timer();

    function prependToHistory(newEntry) {
      document.getElementById('history-col').style.display = 'block';

      let historyElement = document.getElementById('history');
      var current = historyElement.innerHTML.toString();
      if (!current.includes(newEntry)) {
        historyElement.innerHTML = newEntry + current;
      }
    }

    eventSource2.addEventListener('TIMER_REQUEST', (e) => {
      // hide help text
      document.getElementById('help').style.display = 'none';

      console.log('TIMER_REQUEST');
      console.log(e.data);
      var request = JSON.parse(e.data);
      console.log(request);

      updateTimerUser(request.user)
      updateTimerDuration(request.timer)
      if (request.type === 'TIMER') {
        updateTimerType('')
      } else if (request.type === 'BREAKTIMER') {
        updateTimerType('‚òï')
      } else {
        updateTimerType('')
      }

      updateTimerRequested(request.requested);
      let finished = Date.parse(request.requested) + (request.timer * 60 * 1000);
      updateTimerFinished(finished);

      requestedTimestamp = Date.parse(request.requested);
      timerDurationInMilliseconds = request.timer * 60 * 1000;

      prependToHistory(`<li>üïí ${formatTodayAware(request.requested)} üèÅ ${(formatTodayAware(finished))} ${request.type === "BREAKTIMER" ? "‚òï" : "‚è≤"} ${request.timer} min üë§ ${request.user}</li>`);
    });
  </script>
</body>
</html>