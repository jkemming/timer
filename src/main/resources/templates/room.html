<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <link rel="icon" href="/favicon.ico" type="image/x-icon">

  <title>00:00</title>
</head>
<body>

<div class="progress" style="height: 3px;">
  <div class="progress-bar" role="progressbar" id="progressbar" style="width: 0%;"></div>
</div>


<div class="col-lg-8 mx-auto p-3 py-md-5">

  <div class="text-center mb-5">
    #[[${room.name}]]

   <div class="display-1">
     <span id="timer-type"></span>
     <span id="timer" class="font-monospace">00:00</span>
   </div>

    <div>
     <span id="timer-user" class="text-muted"></span>
     <span id="timer-duration" class="text-muted"></span>
     <span id="timer-finished" class="text-muted"></span>
    </div>

  </div></div>

<div class="alert alert-warning" id="audio-interaction" style="display: none;"><button onclick="checkAudioPlayback()">active audio output</button></div>

  <div class="row justify-content-center mb-3">
    <div class="col-4">
        <h5>Help</h5>
      <ul class="list-unstyled">
        <li><code>export MOB_TIMER_ROOM=[[${room.name}]]</code></li>
        <li><code>export MOB_TIMER_USER=override-git-user</code></li>
      </ul>
      <ul class="list-unstyled">
        <li><code>mob start 10</code></li>
        <li><code>mob timer 10</code></li>
        <li><code>mob break 5</code></li>
      </ul>
    </div>
    <div class="col-4">
      <h5>History</h5>
      <ul id="history" class="list-unstyled">
      </ul>
    </div>
  </div>

<footer class="text-center text-muted">
  Created by <a href="https://twitter.com/simonharrer">Dr. Simon Harrer</a> &amp; <a href="https://twitter.com/jochen_christ">Jochen Christ</a>
</footer>

 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
  <script type="text/javascript">
    Notification.requestPermission();
  </script>
  <script type="text/javascript">

    function addLeadingZero(num) {
      return (num < 10 ? '0' : '') + num;
    }

    function getCountdownRemainingTimeString(timerDurationInMilliseconds, elapsedMillisecondsSinceRequested) {
      var remainingDurationInMilliseconds = timerDurationInMilliseconds - elapsedMillisecondsSinceRequested;
      let remainingSeconds = Math.floor(remainingDurationInMilliseconds / 1000);
      let remainingMinutesPart = Math.floor(remainingSeconds / 60);
      let remainingSecondsPart = remainingSeconds % 60;
      return `${addLeadingZero(remainingMinutesPart)}:${addLeadingZero(remainingSecondsPart)}`;
    }

    function getCountdownPercentage(timerDurationInMilliseconds, elapsedMillisecondsSinceRequested) {
      let percentage = elapsedMillisecondsSinceRequested / timerDurationInMilliseconds * 100;
      return Math.max(0, Math.min(100, Math.floor(percentage * 100) / 100));
    }

    function formatTodayAware(timestamp) {
      let date = new Date(timestamp);
      return date.toLocaleDateString() === new Date().toLocaleDateString()
          ? date.toLocaleTimeString()
          : date.toLocaleString();
    }

    var timerDiv = document.getElementById('timer');
    function updateRemainingTime(data) {
      document.title = data;
      timerDiv.innerHTML = data;
    }

    var timerUserDiv = document.getElementById('timer-user');
    function updateTimerUser(data) {
      timerUserDiv.innerHTML = data !== undefined ? ` üë§ ${data}` : '';
    }

    var timerDurationDiv = document.getElementById('timer-duration');
    function updateTimerDuration(data) {
      timerDurationDiv.innerHTML = `‚è≤ ${data} min`;
    }

    var timerTypeDiv = document.getElementById('timer-type');
    function updateTimerType(data) {
      timerTypeDiv.innerHTML = data === 'BREAKTIMER' ? '‚òï' : '';
    }

    var timerFinishedDiv = document.getElementById('timer-finished');
    function updateTimerFinished(data) {
      timerFinishedDiv.innerHTML = data !== undefined ? ` üèÅ ${(formatTodayAware(data))}` : data;
    }

    function checkAudioPlayback() {
      new Audio('/silence.mp3').play().then((e) => {
        console.log("audio working");
        document.getElementById('audio-interaction').style.display = 'none';
      }, (e) => {
        console.log("audio not working")
        document.getElementById('audio-interaction').style.display = 'block';
      })
    }

    function timerFinished() {
      console.log("Timer finished. Notifying user.");

      Notification.requestPermission();
      new Notification('mob next', {
        tag: 'timer-finished',
        silent: false,
        body: "Time's up.",
        lang: 'en',
      });

      let audioFile = '/' + (requestType === "TIMER" ? 'mobnext.mp3' : 'mobstart.mp3');
      new Audio(audioFile).play().then((e) => console.log("worked"), (e) => console.log("could not play " + e))
    }

    let url2 = '/[[${room.name}]]/sse2';
    console.log('setting up event source at ' + url2);
    const eventSource2 = new EventSource(url2);
    eventSource2.onopen = () => {
      console.log('opened connection to ' + url2);
    };
    eventSource2.onerror = (e) => {
      console.log('error on connection to ' + url2 + ": " + e.data);
    };

    let progressbarElement = document.getElementById("progressbar");

    var requestedTimestamp;
    var timerDurationInMilliseconds;
    var isTimerRunning = false;
    var requestType;


    function renderTimer() {
      if (requestedTimestamp !== undefined) {
        var elapsedMillisecondsSinceRequested = Date.now() - requestedTimestamp;
        if (elapsedMillisecondsSinceRequested < timerDurationInMilliseconds) {
          updateRemainingTime(
              getCountdownRemainingTimeString(timerDurationInMilliseconds,
                  elapsedMillisecondsSinceRequested)
          );
          progressbarElement.style = `width: ${getCountdownPercentage(timerDurationInMilliseconds,
              elapsedMillisecondsSinceRequested)}%`;
          isTimerRunning = true;
        } else {
          updateRemainingTime('00:00');
          progressbarElement.style = "width: 0%";

          if (isTimerRunning) {
            timerFinished();
          }

          isTimerRunning = false;
        }
      }
    }

    // loop
    function timer() {
      setTimeout(function () {
        renderTimer();
        timer();
      }, 50);
    }
    timer();

    function prependToHistory(newEntry) {
      let historyElement = document.getElementById('history');
      var current = historyElement.innerHTML.toString();
      if (!current.includes(newEntry)) {
        historyElement.innerHTML = newEntry + current;
      }
    }

    eventSource2.addEventListener('TIMER_REQUEST', (e) => {
      console.log('handling event TIMER_REQUEST ' + e.data);
      var request = JSON.parse(e.data);

      updateTimerUser(request.user)
      updateTimerDuration(request.timer)
      updateTimerType(request.type)


      let finished = Date.parse(request.requested) + (request.timer * 60 * 1000);
      updateTimerFinished(finished);

      requestedTimestamp = Date.parse(request.requested);
      timerDurationInMilliseconds = request.timer * 60 * 1000;
      requestType = request.type

      prependToHistory(`<li>üïí ${formatTodayAware(request.requested)} üë§ ${request.user} ${request.type === "BREAKTIMER" ? "‚òï" : "‚è≤"} ${request.timer} min üèÅ ${(formatTodayAware(finished))}</li>`);
    });

    checkAudioPlayback();
  </script>

<script async defer src="https://scripts.simpleanalyticscdn.com/latest.js"></script>
<noscript><img src="https://queue.simpleanalyticscdn.com/noscript.gif" alt="" referrerpolicy="no-referrer-when-downgrade" /></noscript>
</body>
</html>